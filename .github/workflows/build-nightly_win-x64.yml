name: Build Nightly

on:
  push:
    branches: [ "dev" ]
  # pull_request:
  #   branches: [ "main" ]

jobs:

  build:

    strategy:
      matrix:
        configuration: [Release]

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Install the .NET Core workload
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # Create the app package
    - name: Create the app package
      run: dotnet publish -c Release -r win-x64 /p:Platform=x64

    - name: Create Directory
      shell: pwsh
      run: New-Item -ItemType Directory "/_Pack"

    - name: Build the Installer
      uses: Minionguyjpro/Inno-Setup-Action@main
      with:
        path: ${{ env.GITHUB_WORKSPACE }}/SearchLightER/Setup/naget_Setup_Nightly_Windows-x64.iss
        options: |
          /O/_Pack
          /dMyAppReleaseChannel=nightly
          /dMyAppReleaseNumber=${{ github.sha }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build
        path: /_Pack/naget_Setup.exe

  update-nightly-releases:
    name: Update Nightly Releases
    runs-on: windows-latest
    needs: build

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: /
      - run: |
          dir \

      - name: Generate GitHub Token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.RELEASES_REPO_APP_ID }}
          private-key: ${{ secrets.RELEASES_REPO_PRIVATE_KEY }}
          repositories: |
            Milkeyyy/naget-Releases

      - name: Update Nightly Release (Public)
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        with:
          tag_name: nightly
          name: 'Nightly Build'
          prerelease: true
          body: |
            Nightly Build - Commit `${{ github.sha }}`
            - ${{ github.event.head_commit.message }}
          files: |
            /naget_Setup.exe

      # - name: Update Nightly Release
      #   uses: andelf/nightly-release@main
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: nightly
      #     name: 'Nightly Build'
      #     prerelease: true
      #     body: |
      #       Nightly Build - Commit `${{ github.sha }}`
      #       - ${{ github.event.head_commit.message }}
      #     files: |
      #       /naget_Setup.exe

      - name: Delete Build Artifact
        uses: GeekyEggo/delete-artifact@v5
        with:
          name: build
